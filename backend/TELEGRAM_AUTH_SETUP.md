# Настройка Telegram OAuth для приложения

В этом документе описан процесс настройки аутентификации через Telegram для вашего приложения.

## Быстрая настройка

1. Создайте бота через [@BotFather](https://t.me/botfather) в Telegram
2. Получите токен бота и его имя
3. Запустите скрипт автоматической настройки:

**В Windows:**
```
.\setup-telegram-auth.ps1
```

**В Linux/macOS:**
```
chmod +x setup-telegram-auth.sh
./setup-telegram-auth.sh
```

4. Следуйте инструкциям в скрипте
5. После завершения работы скрипта перезапустите бэкенд и фронтенд

## Ручная настройка

### 1. Создание бота в Telegram

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/botfather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания нового бота:
   - Укажите название бота (например, "My Competition App")
   - Укажите username бота (например, "my_competition_bot")
4. BotFather выдаст вам токен бота. **Сохраните его, это важный секретный ключ!**
5. Настройте команды бота с помощью `/setcommands`:
   ```
   start - Начать взаимодействие с ботом
   auth - Получить код авторизации
   help - Показать справку
   ```
6. Опционально, установите аватар бота с помощью `/setuserpic`

### 2. Настройка окружения (.env файлы)

Создайте следующие файлы:

**backend/.env**
```
# Настройки безопасности
SECRET_KEY="секретный_ключ_для_jwt_токенов"

# Настройки Telegram
TELEGRAM_BOT_TOKEN="ваш_токен_от_BotFather"
TELEGRAM_BOT_NAME="имя_вашего_бота_без_@"
TELEGRAM_BOT_API_KEY="придуманный_вами_секретный_ключ"

# Настройки среды
ENVIRONMENT="local"
```

**frontend/.env.local**
```
VITE_TELEGRAM_BOT_NAME="имя_вашего_бота_без_@"
```

**telegram_bot/.env**
```
# --- Telegram ---
TELEGRAM_BOT_TOKEN="ваш_токен_от_BotFather"
TELEGRAM_BOT_NAME="имя_вашего_бота_без_@"
TELEGRAM_BOT_API_KEY="придуманный_вами_секретный_ключ"
```

### 3. Проверка реализации

Проверьте, что ваш бэкенд корректно обрабатывает данные от Telegram Login Widget:

1. **В файле `backend/app/api/v1/endpoints/auth.py`**:
   - Эндпоинт `/auth/telegram/callback` должен принимать данные от виджета
   - Функция `verify_telegram_hash` должна проверять хеш данных

2. **В файле `backend/app/core/config.py`**:
   - Настройки `TELEGRAM_BOT_TOKEN` и `TELEGRAM_BOT_NAME` должны быть корректно загружены из переменных окружения

### 4. Тестирование

1. Запустите бэкенд:
   ```
   cd backend
   uvicorn app.main:app --reload
   ```

2. Запустите фронтенд:
   ```
   cd frontend
   npm run dev
   ```

3. Откройте страницу логина и нажмите кнопку "Войти через Telegram"
4. Вы должны увидеть виджет Telegram Login, нажмите на него
5. Telegram запросит разрешение на передачу ваших данных, подтвердите
6. Вы должны быть автоматически авторизованы в приложении

## Диагностика проблем

### Сообщение "Username invalid"
Если вместо кнопки Telegram вы видите "Username invalid":
1. Проверьте, что в файле `.env.local` правильно указан `VITE_TELEGRAM_BOT_NAME`
2. Проверьте, что имя бота введено без символа `@` в начале
3. Убедитесь, что скрипт Telegram корректно загружается (проверьте консоль браузера)
4. Перезапустите приложение после изменения переменных окружения

### Ошибка 403 Forbidden при авторизации
1. Проверьте, что токен бота указан правильно в `backend/.env`
2. Убедитесь, что этот же токен использовался для создания хеша
3. Проверьте, что часы на сервере синхронизированы (важно для проверки `auth_date`)

## Важные замечания по безопасности

1. **Никогда не публикуйте токен вашего бота** в исходном коде или публичном репозитории
2. Всегда проверяйте хеш данных от Telegram, это критически важно для безопасности
3. Используйте HTTPS в production-окружении
4. Проверяйте `auth_date` в данных от Telegram, чтобы избежать атак с повторным использованием данных

## Дополнительные ресурсы

- [Официальная документация Telegram Login](https://core.telegram.org/widgets/login)
- [Документация по проверке авторизации](https://core.telegram.org/widgets/login#checking-authorization)
- [Руководство по ботам Telegram](https://core.telegram.org/bots) 